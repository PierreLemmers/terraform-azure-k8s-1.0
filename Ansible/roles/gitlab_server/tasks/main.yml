---
# tasks file for gitlab_server
- name: Install dependencies
  ansible.builtin.apt:
    name: "{{ gitlab_packages }}"
    update_cache: true

- name: Enable UFW (deny inbound by default)
  ansible.builtin.ufw:
    state: enabled
    policy: deny
  when: gitlab_enable_ufw

- name: Allow SSH to GitLab
  ansible.builtin.ufw:
    rule: allow
    port: "{{ gitlab_ssh_port }}"
    proto: tcp
    from_ip: "{{ gitlab_allow_ssh_cidr }}"
  when: gitlab_enable_ufw

- name: Allow HTTPS to GitLab (LAN + runners)
  ansible.builtin.ufw:
    rule: allow
    port: "443"
    proto: tcp
    from_ip: "{{ gitlab_allow_https_cidr }}"
  when: gitlab_enable_ufw

- name: Add GitLab repository script (idempotent)
  ansible.builtin.shell: |
    curl -sS https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh | bash
  args:
    creates: /etc/apt/sources.list.d/gitlab_gitlab-ce.list

- name: Install GitLab CE
  ansible.builtin.apt:
    name: "{{ (gitlab_version | length > 0) | ternary('gitlab-ce=' + gitlab_version, 'gitlab-ce') }}"
    update_cache: true

- name: Configure external_url
  ansible.builtin.lineinfile:
    path: /etc/gitlab/gitlab.rb
    regexp: "^external_url"
    line: "external_url '{{ gitlab_external_url }}'"
  notify: reconfigure gitlab

- name: Reconfigure GitLab if needed
  ansible.builtin.meta: flush_handlers
